# 互协方差、共谱密度、自相关系数、自谱密度
> 这里主要是介绍上面这些概念。  
> - 互协方差 - 共谱密度是一组
> - 自相关系数 - 自谱密度是一组

## 1. 自相关系数 - 自谱密度
### 1.1 一个序列的自相关系数

自相关系数是衡量一个时间序列中任意两个不同时刻取值之间相关程度的统计量。它反映了序列自身不同时间点上的数值之间的线性关联强度。具体定义如下：

对于一个平稳时间序列 {X_t, t ∈ T}，其自相关系数通常记为 ρ(τ)，其中 τ 是时间滞后（lag），表示当前时刻与过去某一时刻的时间间隔。自相关系数 ρ(τ) 在 τ = 0 时定义为 1，这是因为任何序列与其自身的即时值（即 τ = 0）完全相关。对于 τ > 0，自相关系数 ρ(τ) 可以计算为：

\[ \rho(\tau) = \frac{\gamma(\tau)}{\gamma(0)} \]

其中：
- γ(τ) 是自协方差函数，定义为序列在时间间隔 τ 上的均值中心化值的乘积的期望值：

\[ \gamma(\tau) = E[(X_t - \mu_X)(X_{t+\tau} - \mu_X)] \]
- $μ_X$ 是序列 {X_t} 的期望值（平均值）。
- γ(0) 是序列的自协方差在 τ = 0 时的值，即序列的方差：

\[ \gamma(0) = \text{Var}(X_t) \]

自相关系数的取值范围是 [-1, 1]，其中：
- ρ(τ) = 1 表示完全正相关，即序列在时间间隔 τ 处的值与当前值之间存在完美的线性关系。
- ρ(τ) = -1 表示完全负相关，即序列在时间间隔 τ 处的值与当前值之间存在完美的负线性关系。
- ρ(τ) = 0 表示不相关，即序列在时间间隔 τ 处的值与当前值之间不存在线性关联。

### 1.2 **自相关系数与自谱密度**
**自相关系数与自谱密度就是同一个序列在时域和频域的不同表示** 。可以通过先将序列变换到频域，求出自谱密度再逆变换，得到自相关系数。
快速傅里叶变换FFT）是一种高效计算离散傅里叶变换（DFT）的算法，常用于将信号从时域转换到频域。自相关系数可以通过使用FFT进行快速计算。具体步骤如下：


1. **DFT计算**：对原始序列 $X_t$ 或其预处理后的版本进行DFT（通过FFT实现），得到其频域表示 X(f)：
\[ X(f_k) = \sum_{t=0}^{N-1} X_t e^{-j2\pi f_k t / N} \]其中 N 是序列的长度，f_k 是第 k 个频率分量（k = 0, 1, ..., N-1），j 是虚数单位。


2. **频域乘积**：计算序列频域表示与其共轭的乘积，得到自相关函数的频域表示：
\[ R(f_k) = X(f_k) \cdot X^*(f_k) \] 其中 \( X^*(f_k) \) 是 X(f_k) 的复共轭。


3. **IDFT计算**：对自相关函数的频域表示 $R(f_k)$ 进行逆离散傅里叶变换（IDFT，同样可用IFFT实现），将其转换回时域，得到自相关序列 R(τ)：
\[ R(τ_l) = \frac{1}{N} \sum_{k=0}^{N-1} R(f_k) e^{j2\pi f_k \tau_l / N} \]其中 $τ_l$ 是自相关序列中的滞后位置（l = 0, 1, ..., N-1）。注意，这里的 $R(τ_0)$ 就是自相关系数在 τ = 0 时的值，即序列的方差。


4. **标准化**：为了得到自相关系数，需将上述计算得到的自相关序列 $R(τ_l)$ 标准化，除以 $R(τ_0)$（即序列的方差），得到 自相关系数$ρ(τ_l$)：
\[ \rho(\tau_l) = \frac{R(\tau_l)}{R(\tau_0)} \]

这种方法的优点在于，FFT利用了离散傅里叶变换的性质，能够以远低于直接计算自相关函数的时间复杂度完成计算，特别适合处理长序列。在实际应用中，特别是信号处理、时间序列分析等领域，这种基于FFT的计算方法被广泛采用。

## 2. 互协方差 - 共谱密度
互协方差和共谱密度都是描述两个随机信号之间统计依赖关系的量，它们与自相关系数以及自协方差（自谱密度）有着密切的联系，并且也可以通过快速傅里叶变换（FFT）来计算或分析。下面分别介绍这两个概念及其与自相关系数和自协方差的关系：

### 2.1 **互协方差**

互协方差是衡量两个不同时间序列之间线性相关程度的统计量，类似于自协方差描述一个序列内部各时刻值的线性关联。对于两个平稳时间序列 {X_t} 和 {Y_t}，其互协方差定义为：

\[ \text{Cov}(X_t, Y_{t+\tau}) = E[(X_t - \mu_X)(Y_{t+\tau} - \mu_Y)] \]

其中：
- E[] 表示期望值运算；
- \( \mu_X \) 和 \( \mu_Y \) 分别是序列 {X_t} 和 {Y_t} 的平均值；
- τ 是时间滞后，表示当前时刻与另一序列对应时刻的时间间隔。

互协方差衡量了当一个序列在某时刻取值发生变化时，另一个序列在滞后τ时刻取值发生相应变化的趋势。若互协方差为正（负），则两个序列在该滞后下倾向于同向（反向）变化；若互协方差为零，则表明这两个序列在该滞后下没有线性相关性。

### 2.2 **共谱密度**
#### 2.2.1 共谱密度通过时域计算
共谱密度（也称为互谱密度）是互协方差函数在频域的表示，它是互相关函数（两个时间序列之间类似于自相关函数的统计量）的傅里叶变换。对于两个平稳随机过程 ${X(t)} \ {Y(t)}$，其共谱密度 Sxy(f) 定义为：

\[ S_{xy}(f) = \int_{-\infty}^{\infty} R_{xy}(\tau) e^{-j2\pi f \tau} d\tau \]

其中：
- Rxy(τ) 是 ${X(t)} \ {Y(t)} $的互相关函数；
- f 是频率；
- j 是虚数单位。

#### 2.2.2 共谱密度的频域计算
- **步骤1：将时域信号转换到频域**
    对于离散时间信号：
    \[ X[k] = \text{DFT}\{x[n]\} = \sum_{n=0}^{N-1} x[n] e^{-j2\pi kn/N} \] \[ Y[k] = \text{DFT}\{y[n]\} = \sum_{n=0}^{N-1} y[n] e^{-j2\pi kn/N} \]其中：
    - \( \text{DFT}\{\} \) 表示离散傅里叶变换；
    - \( X[k] \) 和 \( Y[k] \) 是离散时间信号在频域的表示；
    - \( N \) 是离散时间信号的点数。

- **步骤2：计算共谱密度**
    已知两个信号在频域的表示 \( X[k] \) 和 \( Y[k] \)，可以直接计算它们的共谱密度（CSD）：\[ S_{xy}[k] = X[k] Y^*[k] \]其中：
    - \( Y^*[k] \) 表示 \( Y[k] \) 的复共轭；
    - \( S_{xy}[k] \) 是离散时间信号的共谱密度。

#### 2.2.3 共谱密度谱归一化：
对于离散时间信号，计算得到的共谱密度通常需要进行适当的归一化，归一化共谱密度（Coherence Function）：\[ C_{xy}[k] = \frac{|S_{xy}[k]|}{\sqrt{S_{xx}[k] \cdot S_{yy}[k]}} \]
其中：
    - \( S_{xy}[k] \) 是共谱密度；
    - \( S_{xx}[k] \) 和 \( S_{yy}[k] \) 分别是信号 \( X[n] \) 和 \( Y[n] \) 的功率谱密度；
    - \( |S_{xy}[k]| \) 是共谱密度的幅度值。
归一化共谱密度的值介于 0 和 1 之间，1 表示完全线性相关，0 表示无相关性。


### 2.3 **与自相关系数和自协方差的关系**

互协方差和共谱密度与自相关系数及自协方差（自谱密度）的关系体现在以下几个方面：

1. **对应关系**：
   - 自协方差是自相关系数在时域的量化形式，自谱密度则是自协方差在频域的对应物。
   - 类似地，互协方差是描述两个序列之间线性相关性的时域统计量，而共谱密度则是这一关系在频域的表述。

2. **计算方法**：
   - 自相关系数和互协方差可以通过类似的方法计算，均涉及对序列值减去各自的平均值后取乘积并求期望。
   - 自谱密度和共谱密度都可以通过快速傅里叶变换（FFT）来计算，将时域的自/互相关函数转换到频域得到自/共谱密度。

3. **物理意义**：
   - 自相关系数和自谱密度提供了一个序列内部不同时间点间或不同频率成分间的相关性信息。
   - 互协方差和共谱密度则揭示了两个不同序列之间在时域或频域上的相互影响程度。只是观察的角度不同。互协方差关注的是这种关联如何随时间滞后变化，而共谱密度则关注这种关联如何随频率分布.
   - 共谱密度提供了两个随机过程在不同频率成分上能量分布的相对关系，即在特定频率下两个过程波动的协同性。 
        - 如果两个过程在某个频率上共谱密度相位为0，说明这两个过程在该频率上同相，同大同小；
        - 反之，若共谱密度相位为$\pi$，则表明存在反相，一个大一个小。
        - 共谱密度相位为$\pi/2$代表信号正交，意味着两个信号在此频率上能量进行有序且有效的转移。此外信号传输时正交信号科研共存不干扰。

4. **应用场合**：
   - 在信号处理、通信工程、时间序列分析等领域，自相关系数和自谱密度常用来分析单个信号的特性，如周期性、趋势、自相似性等。
   - 而互协方差和共谱密度则适用于研究多个信号间的交互作用、干扰分析、滤波设计、系统识别等问题。






这篇文章介绍了SpectFormer，这是一种专为计算机视觉任务设计的新型Transformer架构，它结合了频谱层（spectral layers）和多头注意力层（multi-headed attention layers），以有效捕获图像特征并提升图像识别任务的性能。

## 摘要
ViT已成功应用于图像识别任务。在文本模型中，既有类似于原始工作的基于多头自我注意的（ViT，**DeIT**），也有最近基于光谱层的（Fnet，**GFNet**，AFNO）。受光谱层和层次化Transformer相关工作的启发，论文观察到光谱和多头注意力层的结合能提供更好的Transformer架构，因此提出SpectFormer，使用傅立叶变换实现的光谱层来捕捉架构初始层中的相关特征。此外，在网络的较为深层使用多头自我注意。SpectFormer架构简单，它将图像标记转换到傅立叶域，然后使用可学习的权重参数应用门控技术，最后进行傅立叶逆变换以获取信号。SpectFormer结合了光谱注意力和多头注意力。本文做了非常广泛的实验验证，选择出来了效果最好的频率层

## 创新点：
> [!TIP|label:创新点]
> - **融合频谱与注意力机制：**
> 文章提出了一种新颖的Transformer架构——SpectFormer，它结合了频谱层（spectral layers）与多头注意力层（multi-headed attention layers），打破了以往仅依赖单一机制（如纯频谱或纯注意力）构建视觉Transformer的传统。这一创新设计旨在同时利用频谱分析和自注意力机制的优势，以更全面地捕获图像的特征表示。
> - **频谱层的应用与改进：**
> 1. SpectFormer采用傅立叶变换将图像映射到频域，利用频谱信息进行特征提取。相较于仅依赖多头注意力的传统Transformer，这种处理方式在计算复杂度上有所降低（O(N log N) 对比 O(N^2)），并且减少了参数数量。
> 2. 为了增强频谱层的表现力，SpectFormer引入了频谱门控技术（spectral gating technique），通过学习得到的权重参数对不同频率成分进行加权选择，使模型能够动态调整对不同频率成分的关注，从而更精准地捕获图像的结构信息。
> - **层次化与混合策略：**
> 在模型架构上，SpectFormer采用了层次化设计，通过调整参数α来决定网络中频谱块与注意力块的比例，实现了对图像特征提取深度的灵活控制。特别地，文章指出将频谱层置于网络较浅层，而将注意力层置于深层的配置最为有效，这有助于在早期阶段侧重于捕捉图像的局部频率特征，后期则关注全局上下文和长距离依赖关系。α越大，那么频率层越多。
![swin_att](image/swin_att.png)

## 模型整体架构
![swin_att](image/spectformer_model.png)
**SpectFormer架构包括线性patch嵌入层，后面是位置嵌入层，然后是spectformer块，然后是分类头MLP。**

### patch嵌入层+位置嵌入层
![swin_att](image/patch_embedding.png)
- 线性投影（Linear Projection）：
对每个patch应用一个线性变换（通常是卷积或全连接层），将其从像素值映射到一个低维向量空间，生成patch嵌入。
- 位置编码（Positional Embedding）：
添加位置信息：为每个patch嵌入添加位置编码，这些编码向量携带了patch在原始图像中的相对或绝对位置信息，帮助模型理解各patch间的空间布局

### spectformer层
- 频谱层（Spectral Layer）：
    - 傅立叶变换：对patch嵌入及其位置编码进行快速傅立叶变换（FFT），将图像信息从物理空间转换至频域，提取图像的局部频率特征，如边缘、纹理等。
    - 加权门控：在频域，对不同频率成分施加学习到的权重，突出重要的局部特征，抑制无关或噪声成分。
    - 逆傅立叶变换：将处理后的频域特征通过逆傅立叶变换还原至物理空间。
    - 层归一化与MLP：对IFFT后的特征进行层归一化，确保特征的稳定性。随后使用MLP进行通道混合，进一步丰富特征表达。
- 多头注意力层（Multi-Head Attention Layer）：
    - 多头自注意力：对patch嵌入应用多头自注意力机制，各头部并行计算注意力权重，捕获不同patch之间的依赖关系，特别是长距离依赖。这有助于模型理解图像的整体结构和全局上下文。
    - 层归一化与MLP
> 参数 $\alpha$ 用来控制两种former层的比例. $\alpha$个频谱层，$L-\alpha$个多头注意力层。在SpectFormer块中引入了一个因子，它控制光谱层和注意力层的数量。如果α=0，SpectFormer包括所有注意力层，类似于**DeIT-s**，而当α值为L时，SpectFormer变得类似于**GFNet**，具有所有光谱层。必须注意的是，所有注意力层都具有无法准确捕捉局部特征的缺点。类似地，所有光谱层都具有全局图像属性或语义特征无法准确处理的缺点。

### 分类头层
分类头（Classifier Head）：
- 全局平均池化（GAP）：对最后一层SpectFormer块输出的所有patch嵌入进行全局平均池化，得到一个全局特征向量，代表整张图像的抽象表示。
- 多层感知机（MLP）：将全局特征向量输入一个全连接层（MLP），将特征维度进一步压缩，并映射到与分类标签数相匹配的维度（如ImageNet的1000类）。
- softmax激活：对全连接层输出应用softmax函数，得到每个类别的概率得分。
## 实验结果
- 实验1：ImageNet-1K图像识别任务
结果：SpectFormer在ImageNet-1K数据集上显示出优秀的图像识别性能，相比GFNet-H和LiT，Top-1精度提高了2%。其中，SpectFormer-S（小型版本）达到84.25%的Top-1精度，为当前小规模模型的SOTA；SpectFormer-L（基线版本）达到85.7%的Top-1精度，成为同类规模Transformer模型的SOTA。

- 实验2：迁移学习任务
数据集：CIFAR-10, CIFAR-100, Oxford-IIIT flower, Stanford Car等标准数据集。
方法：使用在ImageNet-1K上预训练的SpectFormer模型进行迁移学习，以应对不同数据集上的图像识别任务。
结果：SpectFormer在这些迁移学习任务中表现出色，与最新的LITv2、RegionViT、PVT等模型相比，不仅明显优于ResNet模型，而且在各项任务中均达到与SOTA频谱网络GFNet相当甚至更高的性能。

- 实验3：MS COCO上的对象检测与实例分割
数据集与任务：MS COCO 2017数据集，用于评估模型在对象检测（object detection）和分割segmentation两个下游任务的表现。
方法：采用RetinaNet和Mask R-CNN两种检测框架，以预训练的SpectFormer作为主干网络进行微调（fine-tuning）。
结果：SpectFormer在MS COCO上展现出一致且与最佳骨干网络相当的性能。与GFNet-H和LiT等模型相比，使用GFL和Cascade Mask R-CNN检测器时，SpectFormer在不同IoU阈值下的平均精度（AP）均有提升，表明其在复杂场景下的目标检测和分割任务上具有竞争力。

- 实验4：模型变体与参数α的消融分析
目的：探究不同频谱层（如FN, FNO, WGN, FGN）对SpectFormer性能的影响，以及参数α对模型结构影响的敏感性分析。
结果：频谱层比较：消融研究表明，在小型网络中，Fourier Gating Network (FGN) 表现优于其他类型的频谱网络，被选为最佳频谱层。
参数α选择：通过不同α值的比较，确定了在SpectFormer架构中最佳的α值，以实现频谱层与注意力层的最佳比例配置。

- 实验5：高分辨率输入下的模型微调
数据集与分辨率：ImageNet，评估在更高分辨率（如384×384）输入下的模型性能。
方法：采用与先前研究相同的训练细节，对SpectFormer模型进行微调。
结果：与GFNet系列模型对比，SpectFormer在高分辨率输入下的性能显著优于GFNet的同规模基础网络。例如，SpectFormer-S(384)的性能比GFNet-S(384)高出1.2%，表明SpectFormer在处理高分辨率图像时依然保持高效，并能进一步提升识别精度。

## 思考
下一步就是把论文中提到的前人的频率层（FN, FNO, WGN, FGN）都去看看明白，这篇文章主要是做了大量实验